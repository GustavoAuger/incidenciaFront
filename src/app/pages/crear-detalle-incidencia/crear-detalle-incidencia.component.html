<!-- Loading Screen -->
<div *ngIf="isLoading" class="fixed inset-0 bg-[#f5f5f5] bg-opacity-90 flex items-center justify-center z-50">
  <div class="text-center">
    <div class="loading loading-spinner loading-lg" style="color: #00bcd4;"></div>
    <p class="mt-2 text-gray-600">Cargando ...</p>
  </div>
</div>

<!-- Existing Content -->
<div class="min-h-screen bg-gray-100 py-8">
  <div class="max-w-7xl mx-auto px-6 sm:px-8 lg:px-10">
    <!-- Título fuera del recuadro -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold">Detalle de Incidencia <span class="text-gray-500 font-normal">({{ incidencia.tipo_estado | initCapFirst }})</span></h2>
    </div>
    <!-- Número de Movimiento (si hay)-->
    <div *ngIf="movimientoNumero" class="text-sm text-gray-600 font-semibold">
      <span class="text-orange-500">Nro Movimiento: {{movimientoNumero}}</span> 
    </div>
    <!-- Contenedor blanco -->
    <div class="bg-white rounded-xl shadow-xl overflow-hidden">
      <!-- Información de cabecera -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 p-8 bg-orange-500">
        <div class="bg-white rounded-lg p-5 shadow-lg">
          <p class="text-orange-500 font-bold text-sm mb-2 text-center">ORIGEN</p>
          <p class="text-black-700 text-lg text-center">{{incidencia.bodOrigenNombre}}</p>
        </div>
        <div class="bg-white rounded-lg p-5 shadow-lg">
          <p class="text-orange-500 font-bold text-sm mb-2 text-center">TRANSPORTE</p>
          <p class="text-black-700 text-lg text-center">{{incidencia.transportistaNombre}}</p>
        </div>
        <div class="bg-white rounded-lg p-5 shadow-lg">
          <p class="text-orange-500 font-bold text-sm mb-2 text-center">OTS</p>
          <p class="text-black-700 text-lg text-center">{{incidencia.ots || '-'}}</p>
        </div>
        <div class="bg-white rounded-lg p-5 shadow-lg">
          <p class="text-orange-500 font-bold text-sm mb-2 text-center">FECHA RECEPCIÓN</p>
          <p class="text-black-700 text-lg text-center">{{incidencia.fechaRecepcion ? (incidencia.fechaRecepcion | date:'dd/MM/yyyy') : ''}}</p>
        </div>
      </div>

      <!-- Formulario -->
      <div class="p-8 bg-gray-50" *ngIf="incidencia.tipo_estado === 'nuevo' && originalIdBodega === incidencia.destino_id_bodega || !modoVisualizacion">
        <form #detalleForm="ngForm">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="form-control"> 
              <label class="label font-semibold text-gray-700">Tipo de Diferencia (*)</label><br> 
              <select class="select select-bordered w-full bg-white tipoDiferencia" [(ngModel)]="detalleIncidencia.tipoDiferencia" name="tipoDiferencia" required> 
                <option value="" disabled selected>Seleccione tipo</option> 
                <option *ngFor="let tipo of tiposDiferencia" [value]="tipo">{{tipo | initCapFirst}}</option> 
              </select> 
            </div>
            <div class="form-control">
              
              <label class="label font-semibold text-gray-700">N° Guía (*)</label><br>
              <input type="number" 
       
                     class="input input-bordered w-full bg-white numGuia" [(ngModel)]="detalleIncidencia.numGuia" name="numGuia" min="0" placeholder="Ingrese N° documento" (change)="onGuiaChange()" />
            </div>

            <div class="form-control">
              <label class="label font-semibold text-gray-700">SKU (*)</label><br>
              <div class="flex gap-4">
                <input class="input input-bordered flex-1 bg-white sku" [(ngModel)]="detalleIncidencia.sku" name="sku" required placeholder="Ingrese SKU" [disabled]="!skuEnabled && (detalleIncidencia.tipoDiferencia=='faltante' || detalleIncidencia.tipoDiferencia=='')"  />
                <button type="button" 
                        class="btn btn-sm flex items-center space-x-2 bg-[#00AFD7] hover:bg-[#00AFD7]/90 text-white h-10 px-4"
                        (click)="buscarProducto()">
                  <span>Buscar</span>
                </button>
              </div>
            </div>

            

            <div class="form-control">
              <label class="label font-semibold text-gray-700">Cantidad (*)</label><br>
              <input type="number" class="input input-bordered w-full bg-white cantidad" [(ngModel)]="detalleIncidencia.cantidad" name="cantidad" required min="1" step="1" placeholder="Ingrese cantidad" (change)="validarCantidad()" [disabled]="!fieldsEnabled" />
            </div>



            <div class="form-control">
              <label class="label font-semibold text-gray-700">N° Bulto </label><br>
              <input class="input input-bordered w-full bg-white" [(ngModel)]="detalleIncidencia.numBulto" name="numBulto" placeholder="Ingrese N° bulto" [disabled]="!fieldsEnabled" />
            </div>
            <div class="form-control">
              <label class="label font-semibold text-gray-700">Descripción</label><br>
              <input class="input input-bordered w-full bg-white" [(ngModel)]="detalleIncidencia.descripcion" name="descripcion" placeholder="Descripción del producto" readonly />
            </div>
            <div class="form-control">
              <label class="label font-semibold text-gray-700">Peso Origen (Kg)</label><br>
              <input class="input input-bordered w-full bg-white" [(ngModel)]="detalleIncidencia.pesoOrigen" name="pesoOrigen" min="0" step="0.01" placeholder="Ingrese peso origen" [disabled]="!fieldsEnabled" />
            </div>

            <div class="form-control">
              <label class="label font-semibold text-gray-700">Peso Recepción (Kg)</label><br>
              <input class="input input-bordered w-full bg-white" [(ngModel)]="detalleIncidencia.pesoRecepcion" name="pesoRecepcion" min="0" step="0.01" placeholder="Ingrese peso recepción" [disabled]="!fieldsEnabled"/>
            </div>

            <div class="form-control flex items-end">
              <button type="button" 
                      class="btn btn-sm flex items-center space-x-2 bg-[#00AFD7] hover:bg-[#00AFD7]/90 text-white h-10 px-4 w-full justify-center" 
                      (click)="agregarDetalle()">
                <span>Agregar detalle</span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Tabla con mejor diseño -->
    <div class="mt-8 bg-white rounded-xl shadow-xl overflow-hidden">
      <div class="overflow-x-auto p-6">
        <table class="table w-full">
          <!-- head -->
          <thead>
           <tr class="text-black">
             <th class="text-center">N°</th>
             <th class="text-center">Tipo de Diferencia</th>
             <th class="text-center">SKU</th>
             <th class="text-center">Descripción</th>
             <th class="text-center">Cantidad</th>
             <th class="text-center">N° Documento</th>
             <th class="text-center">N° Bulto</th>
             <th class="text-center">Peso Origen</th>
             <th class="text-center">Peso Recepción</th>
             <th class="text-center" *ngIf="incidencia.tipo_estado === 'nuevo' && originalIdBodega === incidencia.destino_id_bodega || !modoVisualizacion">Acciones</th>
           </tr>
          </thead>
          <tbody>
             <tr *ngFor="let detalle of detalles; let i = index" class="hover:bg-gray-100">
               <td class="text-center">{{i + 1}}</td>
               <td class="text-center">{{detalle.tipoDiferencia | initCapFirst}}</td>
               <td class="text-center">{{detalle.sku}}</td>
               <td class="text-center">{{detalle.descripcion | initCapFirst}}</td>
               <td class="text-center">{{detalle.cantidad >= 0 ? detalle.cantidad : -detalle.cantidad}}</td>
               <td class="text-center">{{detalle.numGuia}}</td>
               <td class="text-center">{{detalle.numBulto}}</td>
               <td class="text-center">{{detalle.pesoOrigen}}</td>
               <td class="text-center">{{detalle.pesoRecepcion}}</td>
               <td class="text-center" *ngIf="incidencia.tipo_estado === 'nuevo'&& originalIdBodega === incidencia.destino_id_bodega || !modoVisualizacion" >
                <button 
                class="btn btnb btn-sm"
                [ngClass]="{
                  'btn-error': incidencia.tipo_estado !== 'nuevo',
                 
                }"
                [disabled]="incidencia.tipo_estado !== 'nuevo'"
                (click)="eliminarDetalle(i)">
                <span class="material-symbols-outlined"
                [ngClass]="{
                  'btn-error': incidencia.tipo_estado !== 'nuevo',
                  'bg-gray-300 text-gray-500 cursor-not-allowed': incidencia.tipo_estado !== 'nuevo'
                }">delete</span>
              </button>
              </td>
            </tr>
            <tr *ngIf="detalles.length === 0">
              <td colspan="10" class="text-center py-4">No hay detalles agregados</td>
            </tr>
          </tbody>
        </table>
        </div>
    </div>

    <!-- Botones de acción -->
    <div class="px-8 py-6 bg-[#f5f5f5] -mx-8 mt-8 flex justify-between items-center">

      <!-- Botón Volver -->
      <button type="button" 
              class="btn btn-sm flex items-center space-x-2 bg-gray-400 hover:bg-gray-500 text-white h-10 px-4" 
              (click)="navigateTo(fromRoute)">
        <i class="fas fa-arrow-left"></i>
        <span>Volver</span>
      </button>

      <!-- Botón Actualizar Detalle -->
      <button type="button" 
              *ngIf="modoVisualizacion && incidencia.tipo_estado === 'nuevo' && originalIdBodega === incidencia.destino_id_bodega"
              class="btn btn-sm flex items-center space-x-2 bg-[#00AFD7] hover:bg-[#00AFD7]/90 text-white h-10 px-4" 
              (click)="actualizarIncidencia()">
        <span>Actualizar detalle</span>
      </button>
    </div>

    <!-- Botón Generar Incidencia -->
    <div class="mt-8 flex justify-end px-4">
      <button type="button" 
              *ngIf="!modoVisualizacion"
              class="btn btn-sm flex items-center space-x-2 bg-[#00AFD7] hover:bg-[#00AFD7]/90 text-white h-10 px-6" 
              (click)="generarIncidencia()">
        <span>Generar incidencia</span>
      </button>
    </div>
  </div>
</div>